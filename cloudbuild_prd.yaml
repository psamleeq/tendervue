steps:
- name: 'node:14-alpine'
  id: 'Read version'
  entrypoint: 'sh'
  args:
    - '-c'
    - |
      VERSION=$(node -p "require('./package.json').version") && \
      echo "Version is $VERSION" && \
      echo $VERSION > version.txt  # 将版本号写入文件

- name: 'gcr.io/cloud-builders/docker'
  id: 'Build image'
  args:
    - 'build'
    - '-t'
    - 'asia-east1-docker.pkg.dev/$PROJECT_ID/dockers/tender_vue:$(cat version.txt)'  # 使用文件中的版本号
    - '.'
  waitFor: ['Read version']

- name: 'gcr.io/cloud-builders/docker'
  id: 'Push image'
  args:
    - 'push'
    - 'asia-east1-docker.pkg.dev/$PROJECT_ID/dockers/tender_vue:$(cat version.txt)'  # 推送带版本号的镜像
  waitFor: ['Build image']

options:
  logging: CLOUD_LOGGING_ONLY
